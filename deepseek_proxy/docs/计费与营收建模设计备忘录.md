# 计费与营收建模设计备忘录

> 目的：梳理未来“收入 / 支出 / 盈亏”端到端闭环所需的领域模型、数据结构、指标体系与实施路线，作为逐步实现的设计锚点。

---
## 1. 总体目标
实现一个围绕“代理调用服务”产生价值的财务与运营统计体系：
- 精确记录收入（充值 / 套餐 / 流量包 / 退款 / 调整）
- 精确估算 / 记录支出（Prompt 命中 / 未命中 tokens、输出 tokens、推理 tokens 等）
- 支持多维度指标：活跃、留存、付费率、复购率、ARPU、毛利率
- 支撑内部运营看板 + 日/周/月自动结算 + 异常告警（毛利为负、成本飙升）
- 为后续 A/B、动态定价、智能配额策略留接口

---
## 2. 领域模型拆解

| 领域对象 | 含义 | 核心字段 | 备注 |
|----------|------|---------|------|
| User | 注册用户 | id, 注册时间, 渠道, 状态, 当前套餐, 累计消费 | 渠道用于投放效果分析 |
| Plan(套餐) | 预付费打包产品 | plan_id, 名称, 类型(月包/季度/年), 基础配额(调用次数 or tokens), 价格, 失效策略 | 定价版本要有 version 以支持历史回溯 |
| Addon(流量包) | 额外一次性购买的额度 | addon_id, 面值配额, 价格, 叠加策略 | 可按次数或 tokens 两种类型 |
| FreeGrant | 新用户赠送 | user_id, grant_type, 数量, 发放时间, 过期时间 | 记录初始赠送独立流水用于 ROI 分析 |
| QuotaSnapshot | 用户当前剩余额度视图 | user_id, base_remaining, addon_remaining, grant_remaining, updated_at | 供快速查询 |
| UsageEvent | 每次真实调用消耗 | event_id, user_id, request_id, input_tokens_hit, input_tokens_miss, output_tokens, reasoning_tokens, cost_estimate, created_at | 建议 Append Only |
| BillingOrder | 付费订单（套餐 / 流量包） | order_id, user_id, product_type(plan/addon), product_id, price, currency, pay_channel, status, created_at, paid_at | 对接支付系统 |
| BillingAdjustment | 手工调整 | adjust_id, user_id, delta_quota, reason, operator, created_at | 统一审计 |
| Refund | 退款 | refund_id, order_id, amount, reason, created_at | 与订单生命周期关联 |
| TokenCostModel | 成本单价配置 | version, input_hit_price, input_miss_price, output_price, reasoning_price, effective_from | 支持未来调价 |
| DailyFinancialSummary | 每日汇总 | date, total_revenue, total_cost, gross_profit, gross_margin, arpu, paying_users, new_users, churn_users | 定时作业生成 |
| UserLifecycleMetric | 用户生命周期指标 | user_id, first_pay_at, last_pay_at, total_orders, total_revenue, total_usage, ltv | 用于分层运营 |

---
## 3. 事件与流程

### 3.1 新用户注册流程
1. 创建 User 记录
2. 发放 FreeGrant（写 FreeGrant & 更新 QuotaSnapshot）
3. 记录 UserLifecycleMetric 初始化
4. 触发运营/增长埋点（渠道来源）

### 3.2 登录 / 调用流程（已部分实现）
1. 鉴权成功 → 检查配额（QuotaManager）
2. 通过 → 真实发起上游请求 (流式)
3. 解析 usage 字段（已有）→ 形成 UsageEvent
4. 扣减配额（先使用赠送/套餐额度，再用 addon）
5. 写入异步日志 + 推送到事件总线 (Kafka / Redis Stream) 供异步聚合

### 3.3 购买套餐 / 流量包
1. 用户下单 → 创建 BillingOrder(status=pending)
2. 支付回调 → 更新订单为 paid
3. 按产品类型增加配额（Plan → base_remaining 增量；Addon → addon_remaining 增量）
4. 写 QuotaSnapshot / BillingOrder / UserLifecycleMetric(total_revenue+)
5. 触发“付费用户转化”指标刷新

### 3.4 退款 / 调整
- 退款：生成 Refund，冲减收入；配额策略：是否回收未消耗部分（需配置）
- 调整：管理员手动增减配额（记录 BillingAdjustment）

### 3.5 日终批处理 (Daily ETL)
1. 汇总 UsageEvent → 按成本模型计算当日成本
2. 汇总 BillingOrder(paid) - Refund → 当日收入
3. 计算毛利 / 毛利率 / ARPU / 新增付费用户数 / 复购率
4. 落地 DailyFinancialSummary
5. 生成异常告警（例如成本 > 收入 * X）

---
## 4. 成本计算逻辑

令：
- C_hit = Σ input_tokens_hit * price_hit / 1e6
- C_miss = Σ input_tokens_miss * price_miss / 1e6
- C_out = Σ output_tokens * price_output / 1e6
- C_reasoning = Σ reasoning_tokens * price_reasoning / 1e6 (暂缺，可为 0)
- 总成本 Cost_total = C_hit + C_miss + C_out (+ C_reasoning)

当前已经在流中解析：prompt_cache_hit_tokens / miss_tokens / completion_tokens / reasoning_tokens(可选) → 可直接形成 UsageEvent。

---
## 5. 指标体系（首批）

| 维度 | 指标 | 定义 | 现状 |
|------|------|------|------|
| 用户增长 | 新增用户数 | 当日注册用户 | 未实现（日终统计 users.created_at） |
| 转化 | 付费用户数 | 至少有一笔 paid 订单的用户（去重） | 未实现 |
| 转化 | 首付转化率 | 当日新用户中付费人数 / 新增用户数 | 未实现 |
| 收入 | 日收入 | 当日支付成功订单金额 - 退款 | 未实现 |
| 收入 | ARPU | 日收入 / 活跃用户数(或付费用户数做 ARPPU) | 未实现 |
| 收入 | LTV | 用户生命周期累计收入 | 未实现 |
| 成本 | 日成本 | Sum(UsageEvent 成本) | 部分：实时估算存在 / 精确落地未做 |
| 成本 | 单次调用平均成本 | 日成本 / 成功调用次数 | 可做 |
| 盈利 | 毛利 | 日收入 - 日成本 | 未实现 |
| 盈利 | 毛利率 | 毛利 / 日收入 | 未实现 |
| 运营 | 复购率 | 当日付费用户中历史已付费过的比例 | 未实现 |
| 留存 | 次日留存率 | D+1 活跃 / D 新增 | 依赖用户行为日志 |

---
## 6. 数据存储与结构建议

### 6.1 热数据 (在线查询、实时看板)
- Redis / DashMap 内存镜像：QuotaSnapshot
- Prometheus：即时业务 & 性能指标（不放收入敏感数据）

### 6.2 冷数据 / 持久层
- PostgreSQL (推荐)：事务一致性 + 关系查询（订单、用户、UsageEvent）
- 分区策略：UsageEvent 按日期（每日一分区）便于归档
- 索引建议：
  - UsageEvent(user_id, created_at desc)
  - BillingOrder(user_id, paid_at)
  - Refund(order_id)
  - FreeGrant(user_id)

### 6.3 事件流 (可选第二阶段)
- Kafka / Redpanda 主题：`usage.events`, `billing.orders`, `billing.adjustments`
- 下游消费者：实时成本聚合、风控、BI 入仓

---
## 7. API 规划草稿

| API | 方法 | 说明 | 认证 |
|-----|------|------|------|
| /api/admin/users/summary | GET | 用户增长 / 转化基础统计 | 管理员 JWT |
| /api/admin/finance/daily | GET | 指定日期收入成本汇总 | 管理员 |
| /api/admin/finance/usage-stream | GET | 最近 N 条 UsageEvent | 管理员 |
| /api/billing/plans | GET | 展示可购买套餐列表 | 公共 |
| /api/billing/order | POST | 创建订单 | 用户 |
| /api/billing/order/{id}/pay-callback | POST | 支付回调 | 系统内部 |
| /api/billing/addon | POST | 购买流量包 | 用户 |
| /api/billing/refund | POST | 申请退款 | 管理员/客服 |
| /api/quota/snapshot | GET | 当前剩余额度 | 用户 |

---
## 8. 权限 & 审计
- 所有 BillingAdjustment / Refund 必须记录 operator + 原因
- 提供审计日志（写文件 + 异步落 DB）
- 后续支持 RBAC：roles = {admin, finance, support, user}

---
## 9. 实施路线 (增量里程碑)

| 阶段 | 目标 | 范围 | 产出 |
|------|------|------|------|
| M1 | 精确成本事件化 | UsageEvent 表、流解析入库、日终成本作业 | 成本日报（仅成本） |
| M2 | 收入管道基础 | BillingOrder / Addon / FreeGrant / Quota 扣减规则 | 真实收入 + 实时剩余额度 API |
| M3 | 日结毛利 | DailyFinancialSummary 生成与告警 | 毛利日报 / 毛利率阈值告警 |
| M4 | 用户价值 | UserLifecycleMetric、ARPU/付费率/复购率 | 用户分层视图 |
| M5 | 分析 & 优化 | A/B、动态定价预留、异常用量检测 | 运营策略迭代支撑 |

---
## 10. 风险与待决策
| 项目 | 风险 | 缓解 |
|------|------|------|
| usage 字段不稳定 | 字段缺失导致成本低估 | 保留估算 fallback + 标记估算比例 |
| 大量 UsageEvent | 写放大 & 查询慢 | 分区 + 批量写 + 异步入仓 | 
| 多币种需求 | 定价换汇复杂 | 第一版仅 CNY，抽象 currency 字段 | 
| 退款复杂策略 | 先行规则不清 | 定义“未消耗部分可退”默认策略 | 
| 权限泄露 | 管理接口越权 | 统一 middleware + 操作审计 | 

---
## 11. 需要后续确认的问题
1. 赠送额度是否可与套餐叠加并先消费哪一种？（推荐先消耗赠送，避免拖欠）
2. 流量包是否有有效期？
3. 退款是否回收已使用的套餐部分？比例如何计算？
4. 成本统计是按实时还是以 Day+1 校准（上游可能延迟）？
5. 是否需要支持多组织 / 多租户（B2B 场景）？
6. 是否需要对单用户设置成本/收入异常阈值进行风控？

---
## 12. 快速数据字典（核心表草案）

```sql
-- UsageEvent
CREATE TABLE usage_event (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  request_id TEXT NOT NULL,
  input_tokens_hit INT DEFAULT 0,
  input_tokens_miss INT DEFAULT 0,
  output_tokens INT DEFAULT 0,
  reasoning_tokens INT DEFAULT 0,
  cost_estimate NUMERIC(18,6) DEFAULT 0,
  raw_usage JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
) PARTITION BY RANGE (created_at);

-- BillingOrder
CREATE TABLE billing_order (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  product_type SMALLINT NOT NULL, -- 0 plan, 1 addon
  product_id BIGINT NOT NULL,
  price NUMERIC(12,2) NOT NULL,
  currency VARCHAR(8) NOT NULL DEFAULT 'CNY',
  pay_channel VARCHAR(32),
  status SMALLINT NOT NULL, -- 0 pending,1 paid,2 failed,3 refunded
  created_at TIMESTAMP DEFAULT NOW(),
  paid_at TIMESTAMP
);
```

---
## 13. 后续快速实验点
- (A) 记录 UsageEvent 到本地文件 + 每 60 秒批量入库（模拟）
- (B) 小的内存聚合器：实时显示“今日收入/成本/毛利”趋势
- (C) 加一个 Prometheus gauge：estimated_gross_margin_today

---
## 14. 总结
当前已具备实时 token 使用解析的基础。下一步按照 *成本事件化 → 收入通道 → 日结毛利 → 用户价值* 四个递进阶段推进，可最大化渐进式收益并降低一次性设计过载风险。此文作为未来实现的蓝图与核对清单。

---
(完)
